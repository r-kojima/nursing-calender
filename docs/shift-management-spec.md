# シフト設定機能 仕様書

## 概要

保育園のスタッフのシフト（勤務予定）を月間カレンダー形式で管理する機能。
各メンバーの日々の勤務時間を登録・編集・削除できる。

## データモデル

### Shift (シフト)

| フィールド | 型 | 説明 | 制約 |
|-----------|-----|------|------|
| id | String | シフトID | Primary Key (UUID) |
| memberId | String | メンバーID | Foreign Key → Member |
| workTimeTypeId | String? | 勤務時間タイプID | Foreign Key → WorkTimeType (nullable) |
| date | DateTime | シフト日付 | @db.Date (時刻なし) |
| note | String? | 備考 | 最大長未定義 |
| createdAt | DateTime | 作成日時 | 自動設定 |
| updatedAt | DateTime | 更新日時 | 自動更新 |

**制約:**
- `@@unique([memberId, date])`: 1メンバー1日1シフトのみ
- `onDelete: Cascade`: メンバー削除時にシフトも削除
- `onDelete: SetNull`: WorkTimeType削除時にworkTimeTypeIdをnullに設定

**休日の表現:**
- `workTimeTypeId` が `null` の場合は「休み」を意味する
- 休みの日にも備考を付けることができる

## 機能要件

### 1. シフト一覧表示

**表示形式:**
- 月間カレンダー形式（一般的なカレンダーレイアウト）
- 週単位で表示（日曜日〜土曜日）
- 自分（ログインユーザー）のシフトのみを表示

**表示内容（各セル）:**
- 日付（左上に固定表示）
- 勤務時間タイプの名前（例: "早番"）
  - 時刻は表示しない（シンプルさ重視）
- カレンダー表示色（WorkTimeTypeのcolor）
- 備考がある場合は小さいドット表示（右上）

**操作:**
- 通常モード: セルクリックでシフト編集モーダルを開く
- シフト設定モード: セルクリックで選択中の日付として設定
- 月の切り替え（前月/翌月ボタン）
- 今月に戻るボタン
- 「シフト設定」ボタン（カレンダー上部に配置）

### 2. シフト設定モード（連続登録）

**起動方法:**
- カレンダー上部の「シフト設定」ボタンをクリック

**UI表示:**
- 画面下部にシフトパターン選択パネルが表示される
- パネルには有効な（isActive=true）WorkTimeTypeが一覧表示される
- 「休み」も選択肢として含まれる
- カレンダーに「選択中の日付」が存在する（視覚的に強調表示）
- 「完了」ボタンでシフト設定モードを終了

**選択中の日付:**
- シフト設定モード開始時は今日の日付が選択される（今日が表示月内にある場合）
- 今日が表示月外の場合は、その月の1日が選択される
- 選択中の日付は背景色で視覚的に強調表示
- カレンダーのセルをクリックすると、そのセルが選択中の日付になる

**操作フロー:**
1. 「シフト設定」ボタンをクリック
2. 画面下部にシフトパターン選択パネルが表示
3. カレンダーのセルをクリックして日付を選択（任意）
4. シフトパターン（早番、遅番、休み等）をクリック
5. 選択中の日付に即座にシフトが設定される（楽観的UI更新）
6. バックグラウンドでAPI呼び出し（UPSERT）
7. 選択中の日付が自動的に翌日に移動
8. 月末の場合は翌月の1日に移動（カレンダー表示も翌月に切り替わる）
9. 続けて別のシフトパターンをクリック可能（翌日に設定される）
10. 「完了」ボタンでシフト設定モードを終了

**キーボード操作（将来拡張）:**
- ←→キーで選択中の日付を前後に移動
- 数字キー1-9でシフトパターンを選択
- Enterキーで選択中のパターンを設定

**楽観的UI更新:**
- シフトパターンクリック時に即座にUI上でシフトを反映
- 選択中の日付を翌日に移動
- バックグラウンドでAPI呼び出し
- 失敗時はトースト通知でエラー表示し、該当セルを元に戻す

**UPSERT処理:**
- 同じメンバー・同じ日付のシフトが既に存在する場合は更新（UPDATE）
- 存在しない場合は新規作成（INSERT）
- 備考は保持（既存の備考がある場合は上書きしない）
- API: `PUT /api/shifts/upsert`

### 3. シフト個別編集モード（詳細編集）

**起動方法:**
- 通常モード時にカレンダーのセルをクリック

**編集方法:**
- モーダルダイアログで編集

**編集項目:**
1. **日付** (表示のみ)
2. **勤務時間タイプ** (必須、ドロップダウン選択)
   - "休み"を含む選択肢リスト
   - 有効な（isActive=true）WorkTimeTypeのみ表示
   - "休み"を選択した場合は workTimeTypeId = null
3. **備考** (任意、テキストエリア)

**バリデーション:**
- 勤務時間タイプは必須（"休み"を含む）

**削除機能:**
- 編集モーダル内に「削除」ボタンを配置
- 確認ダイアログを表示してから物理削除

**API:**
- PUT `/api/shifts/upsert` - 新規作成または更新
- DELETE `/api/shifts/[id]` - 削除

## UI/UX要件

### カレンダー表示（通常モード）

**レイアウト:**
```
┌──────────────────────────────────────────────────────┐
│  [< 前月] 2025年1月 [今月] [翌月 >]    [シフト設定]   │
├────┬────┬────┬────┬────┬────┬────┤
│ 日 │ 月 │ 火 │ 水 │ 木 │ 金 │ 土 │
├────┼────┼────┼────┼────┼────┼────┤
│    │    │    │ 1  │ 2  │ 3  │ 4  │
│    │    │    │早番│休み│遅番•│早番│
├────┼────┼────┼────┼────┼────┼────┤
│ 5  │ 6  │ 7  │ 8  │ 9  │10  │11  │
│休み│早番│遅番│早番│休み│遅番│早番│
├────┼────┼────┼────┼────┼────┼────┤
│ ...                                │
└────┴────┴────┴────┴────┴────┴────┘
```

**色分け:**
- 各勤務時間タイプの color を背景色として使用
- 休みは背景色なし（白/ダーク時はグレー）
- 今日の日付はリング（枠線）で強調
- 備考がある場合は右上に小さいドット（•）を表示
- 前月・翌月の日付はグレーアウト表示

**レスポンシブ対応:**
- スマートフォン: セル高さ 80px、フォント小（text-xs）、1画面に収まるレイアウト
- PC（sm以上）: セル高さ 120px、フォント中（text-sm）、ゆとりのあるレイアウト
- 横スクロール不要（画面幅に自動フィット）

### シフト設定モード

**レイアウト:**
```
┌──────────────────────────────────────────────────────┐
│  [< 前月] 2025年1月 [今月] [翌月 >]        [完了]     │
├────┬────┬────┬────┬────┬────┬────┤
│ 日 │ 月 │ 火 │ 水 │ 木 │ 金 │ 土 │
├────┼────┼────┼────┼────┼────┼────┤
│    │    │    │ 1  │ 2  │ 3  │◆4  │ ← 選択中
│    │    │    │早番│休み│遅番│早番│
├────┼────┼────┼────┼────┼────┼────┤
│ 5  │ 6  │ 7  │ 8  │ 9  │10  │11  │
│休み│早番│遅番│早番│休み│遅番│早番│
└────┴────┴────┴────┴────┴────┴────┘
┌──────────────────────────────────────────────────────┐
│ シフトパターンをクリックしてください                 │
│ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐            │
│ │早番│ │遅番│ │夜勤│ │休み│ │日勤│  ...       │
│ └───┘ └───┘ └───┘ └───┘ └───┘            │
└──────────────────────────────────────────────────────┘
```

**UI変化:**
- 「シフト設定」ボタンが「完了」ボタンに変わる
- カレンダーに「選択中の日付」が表示される（太い枠線や背景色で強調、◆マーク等）
- カレンダーのセルがクリック可能（ホバー時に強調）
- 画面下部にシフトパターン選択パネルが表示

**選択中の日付の視覚表現:**
- 背景に薄いオレンジ色のオーバーレイ

**シフトパターンカード:**
- 勤務時間タイプの color を背景色として使用
- 名前のみを表示（時刻は表示しない）
- クリックで即座にシフトが設定され、選択中の日付が翌日に移動
- ホバー時に軽く拡大するアニメーション

### シフト編集モーダル

**編集時:**
```
┌─────────────────────────────────┐
│  シフトの編集              [×]  │
├─────────────────────────────────┤
│                                 │
│ メンバー: 山田太郎               │
│ 日付: 2025年1月15日              │
│                                 │
│ 勤務時間 *                       │
│ [▼ 早番 (07:00-16:00) ]         │
│                                 │
│ 備考                            │
│ ┌─────────────────────┐       │
│ │                     │       │
│ └─────────────────────┘       │
│                                 │
│ [削除]     [キャンセル] [保存]   │
└─────────────────────────────────┘
```

**新規作成時（セルが空の場合）:**
- 日付は自動入力（カレンダーのセル情報から）
- 勤務時間タイプはデフォルト未選択
- 備考は空欄

## API仕様

### GET /api/shifts/my

自分のシフト一覧を取得（ログインユーザーの自分自身のメンバーのシフト）

**クエリパラメータ:**
- `year`: 年 (必須)
- `month`: 月 1-12 (必須)

**レスポンス:**
```json
{
  "shifts": [
    {
      "id": "shift-uuid",
      "date": "2025-01-15",
      "note": "午後から研修",
      "workTimeType": {
        "id": "type-uuid",
        "name": "早番",
        "startTime": "07:00",
        "endTime": "16:00",
        "color": "#FF6B35"
      }
    }
  ]
}
```

### PUT /api/shifts/upsert

自分のシフトを新規作成または更新（UPSERT）

**用途:**
- シフト設定モードでの連続登録
- シフト編集モーダルでの保存

**リクエストボディ:**
```json
{
  "date": "2025-01-15",
  "workTimeTypeId": "type-uuid",  // nullで休み
  "note": "午後から研修"          // 任意、省略可
}
```

**UPSERT挙動:**
- ログインユーザーの自分自身のメンバーと `date` の組み合わせでシフトを検索
- 存在する場合: 既存のシフトを更新
  - `note` が省略された場合は既存の備考を保持
  - `note` が指定された場合は上書き
- 存在しない場合: 新規作成

**レスポンス:**
```json
{
  "shift": {
    "id": "shift-uuid",
    "workTimeTypeId": "type-uuid",
    "date": "2025-01-15",
    "note": "午後から研修"
  }
}
```

### DELETE /api/shifts/[id]

シフトを削除（物理削除）

**レスポンス:**
```json
{
  "success": true
}
```

## 実装順序

1. **Phase 1: API実装**
   - GET /api/shifts (月間取得)
   - PUT /api/shifts/upsert (UPSERT処理)
   - DELETE /api/shifts/[id] (削除)

2. **Phase 2: カレンダー基本表示**
   - 月間カレンダーコンポーネント
   - シフトデータの表示
   - 月の切り替え機能
   - 備考ドット表示

3. **Phase 3: シフト編集モーダル**
   - シフト編集モーダルコンポーネント
   - フォームバリデーション
   - UPSERT・削除操作の統合
   - 通常モード時のセルクリック

4. **Phase 4: シフト設定モード**
   - シフトパターン選択パネル
   - シフト設定モード切り替え
   - 楽観的UI更新
   - セルクリックでの連続登録

5. **Phase 5: UI/UX改善**
   - レスポンシブ対応
   - ローディング状態表示
   - エラーハンドリング（トースト通知）
   - アニメーション効果

## パフォーマンス考慮事項

1. **データ取得:** 月単位で絞り込んで取得（全期間取得しない）
2. **楽観的UI更新:**
   - シフト設定モード: クリック時に即座にUIを更新、バックグラウンドでAPI呼び出し
   - シフト編集モード: 保存後はrouter.refresh()で再取得
3. **API最適化:**
   - UPSERT処理により不要なGETリクエストを削減
   - 備考が変更されない場合は既存値を保持（無駄な更新を防ぐ）

## アクセシビリティ

1. **キーボード操作:** モーダルのフォーカス管理
2. **スクリーンリーダー対応:** aria-labelの適切な使用
3. **色だけに依存しない:** 勤務時間名も併記

## 今後の拡張案

1. **シフトパターン:** 週単位・月単位のパターン登録
2. **シフトテンプレート:** よく使うシフトの組み合わせを保存
3. **通知機能:** シフト変更時のメール通知
4. **統計機能:** 月間勤務時間の集計
5. **印刷機能:** PDFエクスポート
6. **モバイルアプリ:** PWA対応
